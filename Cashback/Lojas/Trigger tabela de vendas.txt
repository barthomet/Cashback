USE [LINXPOS_ANJUSS_MARACANA]
GO

/****** Object:  Trigger [dbo].[TRG_INSERT_CASHBACK]    Script Date: 24/09/2024 10:20:03 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


CREATE  TRIGGER [dbo].[TRG_INSERT_CASHBACK]
ON [dbo].[LOJA_VENDA]
AFTER INSERT, UPDATE
AS
BEGIN
    -- Insere novos registros na tabela ANJUSS_CASHBACKS_GERADOS se ainda não existirem
    INSERT INTO ANJUSS_CASHBACKS_GERADOS (VENDA_FILIAL, TICKET, CODIGO_FILIAL, CODIGO_CLIENTE, VALOR_VENDA, DATA_BONUS, DATA_EXPIRACAO, VALOR_BONUS, STATUS,vendedor)
    SELECT 
        CONCAT(TRIM(i.CODIGO_FILIAL), ' - ', i.TICKET) AS VENDA_FILIAL,
        i.TICKET,
        i.CODIGO_FILIAL,
        i.CODIGO_CLIENTE,
        i.VALOR_PAGO AS VALOR_VENDA,
        i.DATA_VENDA AS DATA_BONUS,
        DATEADD(DAY, 32, i.DATA_VENDA) AS DATA_EXPIRACAO,
        i.VALOR_PAGO * 0.10 AS VALOR_BONUS,
        'ATIVO' AS STATUS,
		i.VENDEDOR
    FROM loja_venda i
	join CLIENTES_VAREJO z on i.CODIGO_CLIENTE=z.CODIGO_CLIENTE
    WHERE (i.DATA_HORA_CANCELAMENTO IS NULL OR i.VALOR_CANCELADO = 0 OR i.TOTAL_QTDE_CANCELADA = 0)
      AND i.VALOR_pago > 0
      AND i.CODIGO_CLIENTE IS NOT NULL and i.CPF_CGC_ECF is not null 
      AND i.DATA_VENDA >= GETDATE()-1 and OPERACAO_VENDA='01'
	  and SEXO is not null and CELULAR is not null and ANIVERSARIO is not null
      AND NOT EXISTS (
          SELECT 1 
          FROM ANJUSS_CASHBACKS_GERADOS ac 
          WHERE ac.VENDA_FILIAL = CONCAT(TRIM(i.CODIGO_FILIAL), ' - ', i.TICKET)
      );

	      UPDATE ac
    SET ac.VALOR_BONUS = i.VALOR_PAGO * 0.10
    FROM ANJUSS_CASHBACKS_GERADOS ac
    JOIN INSERTED i ON ac.VENDA_FILIAL = CONCAT(TRIM(i.CODIGO_FILIAL), ' - ', i.TICKET)
    WHERE ac.VALOR_BONUS <> i.VALOR_PAGO * 0.10;

END;
GO

ALTER TABLE [dbo].[LOJA_VENDA] ENABLE TRIGGER [TRG_INSERT_CASHBACK]
GO


